generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String
  role         String   @default("USER") // COMPENSATION_MANAGER, HR_ADMIN, BU_LEADER, DEPARTMENT_HEAD, USER
  systemRoleId String?  // Link to SystemRole for permissions
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // System role for permissions
  systemRole           SystemRole?    @relation(fields: [systemRoleId], references: [id])

  // Management relationships
  managedBusinessUnits BusinessUnit[] @relation("BULeader")
  managedDepartments   Department[]   @relation("DepartmentHead")

  // Other relationships
  approvals                Approval[]
  hiringProposals          HiringProposal[]
  compensationActions      CompensationAction[]
  createdCycles            PlanningCycle[]      @relation("CycleCreator")
  approvalAssignments      ApprovalChainAssignee[]
  workforcePlanAssignments WorkforcePlanAssignment[]
  budgetOwnerDepartments   Department[]         @relation("BudgetOwner")
}

// ============================================
// SYSTEM ROLES & PERMISSIONS
// ============================================

model SystemRole {
  id           String   @id @default(cuid())
  name         String   @unique // "Compensation Manager", "HR Admin", etc.
  code         String   @unique // "COMPENSATION_MANAGER", "HR_ADMIN", etc.
  description  String?
  isSystemRole Boolean  @default(true) // true = cannot be deleted
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  permissions RolePermission[]
  users       User[]
}

model RolePermission {
  id           String   @id @default(cuid())
  systemRoleId String
  resource     String   // budget_allocation, headcount_plan, pay_grade, compensation_cycle, etc.
  actions      String   // JSON array: ["view", "create", "edit", "delete", "approve"]
  scope        String   // own, department, cost_center, bu, all
  createdAt    DateTime @default(now())

  systemRole SystemRole @relation(fields: [systemRoleId], references: [id], onDelete: Cascade)

  @@unique([systemRoleId, resource])
}

// ============================================
// ORGANIZATION STRUCTURE
// ============================================

model BusinessUnit {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?
  leaderId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leader      User?        @relation("BULeader", fields: [leaderId], references: [id])
  costCenters CostCenter[]
  budgetAllocations BudgetAllocation[]
}

model CostCenter {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String
  type           String   @default("OPEX") // OPEX, CAPEX
  businessUnitId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  businessUnit      BusinessUnit?      @relation(fields: [businessUnitId], references: [id])
  departments       Department[]
  budgetAllocations BudgetAllocation[]
  expenses          Expense[]
}

model Department {
  id             String   @id @default(cuid())
  name           String
  code           String   @unique
  headId         String?
  budgetOwnerId  String?  // Budget owner (may differ from head)
  parentDeptId   String?  // For hierarchical departments
  costCenterId   String?
  location       String?  // e.g., "Hyderabad, IN"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  head                     User?              @relation("DepartmentHead", fields: [headId], references: [id])
  budgetOwner              User?              @relation("BudgetOwner", fields: [budgetOwnerId], references: [id])
  parentDept               Department?        @relation("DeptHierarchy", fields: [parentDeptId], references: [id])
  childDepts               Department[]       @relation("DeptHierarchy")
  costCenter               CostCenter?        @relation(fields: [costCenterId], references: [id])
  roles                    Role[]
  employees                Employee[]
  positions                Position[]
  departmentBudgets        DepartmentBudget[]
  headcountPlans           HeadcountPlan[]
  budgetAllocations        BudgetAllocation[]
  hiringProposals          HiringProposal[]
  workforcePlans           WorkforcePlan[]
  workforcePlanAssignments WorkforcePlanAssignment[]

  @@index([parentDeptId])
}

model Role {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique
  departmentId String
  payGradeId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  department      Department       @relation(fields: [departmentId], references: [id])
  payGrade        PayGrade?        @relation(fields: [payGradeId], references: [id])
  employees       Employee[]
  hiringProposals HiringProposal[]
}

// ============================================
// PLANNING CYCLES (Budget Cycles)
// ============================================

model PlanningCycle {
  id          String   @id @default(cuid())
  name        String   // "FY 2025", "H1 2025"
  type        String   // ANNUAL, HALF_YEARLY
  startDate   DateTime
  endDate     DateTime
  totalBudget Float    @default(0) // Total budget for this cycle
  status      String   @default("DRAFT") // DRAFT, ALLOCATION, REVIEW, APPROVED, ACTIVE, CLOSED
  createdById String?

  // Configurable approval workflow options
  autoApproveIfMissing Boolean @default(false) // Auto-approve if approver is missing
  skipApproverEmails   Boolean @default(false) // Do not email approvers for every request

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy                User?              @relation("CycleCreator", fields: [createdById], references: [id])
  budgetAllocations        BudgetAllocation[]
  headcountPlans           HeadcountPlan[]
  hiringProposals          HiringProposal[]
  compensationCycles       CompensationCycle[]
  expenses                 Expense[]
  approvalChainLevels      ApprovalChainLevel[]
  workforcePlans           WorkforcePlan[]
  workforcePlanAssignments WorkforcePlanAssignment[]
  departmentBudgets        DepartmentBudget[]
}

// ============================================
// BUDGET MANAGEMENT
// ============================================

model BudgetAllocation {
  id               String   @id @default(cuid())
  cycleId          String

  // Hierarchical level - only ONE of these should be set
  businessUnitId   String?  // BU-level allocation
  costCenterId     String?  // Cost Center-level allocation
  departmentId     String?  // Department-level allocation

  // Parent allocation reference (for hierarchy validation)
  parentAllocationId String?

  // Salary Budget (split into fixed and variable per PRD)
  salaryFixed      Float    @default(0) // Min: 10000 for departments
  salaryVariable   Float    @default(0) // Variable compensation budget

  // Benefits Budget (split per PRD)
  benefitsEmployee Float    @default(0) // Employee-paid benefits
  benefitsEmployer Float    @default(0) // Employer-paid benefits

  // Hiring Budget
  newHiringBudget  Float    @default(0) // Budget for new hires

  // Legacy fields for backward compatibility
  totalBudget      Float    // Computed: sum of all above
  salaryBudget     Float    @default(0) // Keep for backward compatibility
  benefitsBudget   Float    @default(0) // Keep for backward compatibility
  hiringBudget     Float    @default(0) // Keep for backward compatibility

  // Previous year reference
  previousYearBudget    Float? // Last year's budget for comparison
  recommendedAllocation Float? // System recommendation

  // Workflow status
  status           String   @default("DRAFT") // DRAFT, SUBMITTED, PENDING_APPROVAL, REVISION_REQUIRED, APPROVED, LOCKED
  version          Int      @default(1) // Version number for optimistic locking
  submittedAt      DateTime?
  submittedBy      String?
  approvedAt       DateTime?
  approvedBy       String?

  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cycle        PlanningCycle @relation(fields: [cycleId], references: [id])
  businessUnit BusinessUnit? @relation(fields: [businessUnitId], references: [id])
  costCenter   CostCenter?   @relation(fields: [costCenterId], references: [id])
  department   Department?   @relation(fields: [departmentId], references: [id])
  approvals    Approval[]
  comments     BudgetComment[]

  @@unique([cycleId, businessUnitId])
  @@unique([cycleId, costCenterId])
  @@unique([cycleId, departmentId])
  @@index([cycleId])
  @@index([departmentId])
  @@index([status])
}

model BudgetComment {
  id                 String   @id @default(cuid())
  budgetAllocationId String
  userId             String
  userName           String
  comment            String
  isRevisionRequest  Boolean  @default(false)
  createdAt          DateTime @default(now())

  budgetAllocation BudgetAllocation @relation(fields: [budgetAllocationId], references: [id])
}

// ============================================
// PAY STRUCTURE
// ============================================

model PayGrade {
  id        String   @id @default(cuid())
  code      String   // e.g., 'A', 'B', 'C'
  name      String   // "Grade 1", "L5", "Senior Band"
  level     Int      @unique
  band      Int      @default(1) // Band within grade (e.g., 1, 2, 3)

  // Compensation range
  minSalary Float    // compMin
  midSalary Float    // compMidpoint (can be calculated)
  maxSalary Float    // compMax

  currencyCode  String   @default("USD")
  status        String   @default("DRAFT") // DRAFT, ACTIVE, INACTIVE
  effectiveDate DateTime @default(now())
  expiryDate    DateTime?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles     Role[]
  employees Employee[]
  jobLevels JobLevel[]

  @@unique([code, band, level])
}

// ============================================
// EMPLOYEES
// ============================================

model Employee {
  id                String    @id @default(cuid())
  employeeId        String    @unique
  name              String
  email             String    @unique
  title             String
  departmentId      String
  roleId            String?
  payGradeId        String?
  currentSalary     Float
  hireDate          DateTime
  performanceRating String?   // e.g., "Exceeds", "Meets", "Below"
  location          String?   // e.g., "Hyderabad, Telangana, IN"
  status            String    @default("ACTIVE") // ACTIVE, TERMINATED, ON_LEAVE
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  department          Department           @relation(fields: [departmentId], references: [id])
  role                Role?                @relation(fields: [roleId], references: [id])
  payGrade            PayGrade?            @relation(fields: [payGradeId], references: [id])
  compensationActions CompensationAction[]
  assignments         Assignment[]

  @@index([departmentId])
  @@index([status])
}

// ============================================
// HEADCOUNT PLANNING
// ============================================

model HeadcountPlan {
  id               String   @id @default(cuid())
  cycleId          String
  departmentId     String
  roleId           String?  // Optional: for role-level planning
  plannedHeadcount Int      // Target headcount
  approvedHires    Int      @default(0) // Approved new hires
  actualHeadcount  Int      @default(0) // Current actual

  // Cost tracking
  wageBudget       Float    // Total wage cost budget
  actualWageCost   Float    @default(0) // Actual spent

  // Average hiring cost breakdown (per position)
  avgHiringCost         Float  @default(0)
  avgHiringCostFixed    Float  @default(0)
  avgHiringCostVariable Float  @default(0)
  avgHiringCostBenefits Float  @default(0)

  // Override fields (NULL means use calculated value)
  fillRateOverride      Float?  // Manual override for fill rate
  hiringBudgetOverride  Float?  // Manual override for hiring budget
  overrideReason        String? // Required when override is set

  status           String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED, PARTIALLY_FILLED, FILLED
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cycle      PlanningCycle @relation(fields: [cycleId], references: [id])
  department Department    @relation(fields: [departmentId], references: [id])
  approvals  Approval[]

  @@unique([cycleId, departmentId])
  @@index([cycleId])
  @@index([departmentId])
}

// ============================================
// HIRING PROPOSALS
// ============================================

model HiringProposal {
  id             String   @id @default(cuid())
  cycleId        String
  departmentId   String
  roleId         String?
  proposedBy     String
  positionTitle  String
  quantity       Int      @default(1)
  justification  String
  proposedSalary Float
  startMonth     Int      // 1-12
  status         String   @default("DRAFT") // DRAFT, SUBMITTED, HR_REVIEW, FINANCE_REVIEW, APPROVED, REJECTED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  cycle      PlanningCycle @relation(fields: [cycleId], references: [id])
  department Department    @relation(fields: [departmentId], references: [id])
  role       Role?         @relation(fields: [roleId], references: [id])
  proposer   User          @relation(fields: [proposedBy], references: [id])
  approvals  Approval[]
}

// ============================================
// COMPENSATION CYCLES
// ============================================

model CompensationCycle {
  id           String   @id @default(cuid())
  cycleId      String   // Links to budget planning cycle
  name         String   // "Annual Review 2025", "Q1 Bonus"
  type         String   // ANNUAL_REVIEW, MID_YEAR_REVIEW, BONUS, PROMOTION, MARKET_ADJUSTMENT

  // Feature Flags (per PRD)
  enableSalaryRevision Boolean @default(false)
  enableBonus          Boolean @default(false)
  enablePromotion      Boolean @default(false)

  budgetAmount  Float
  startDate     DateTime?
  endDate       DateTime?
  effectiveDate DateTime
  status        String   @default("DRAFT") // DRAFT, OPEN, IN_PROGRESS, LOCKED, COMPLETED, CANCELLED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  planningCycle PlanningCycle        @relation(fields: [cycleId], references: [id])
  actions       CompensationAction[]
}

model CompensationAction {
  id                  String   @id @default(cuid())
  compensationCycleId String
  employeeId          String
  proposedBy          String
  actionType          String   // MERIT_INCREASE, PROMOTION, BONUS, ADJUSTMENT
  currentSalary       Float
  proposedSalary      Float?
  proposedBonus       Float?
  percentageChange    Float?
  justification       String?
  status              String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  compensationCycle CompensationCycle @relation(fields: [compensationCycleId], references: [id])
  employee          Employee          @relation(fields: [employeeId], references: [id])
  proposer          User              @relation(fields: [proposedBy], references: [id])
  approvals         Approval[]
}

// ============================================
// EXPENSE TRACKING (OPEX)
// ============================================

model Expense {
  id           String   @id @default(cuid())
  cycleId      String
  costCenterId String
  category     String   // SALARY, BENEFITS, TRAINING, EQUIPMENT, RECRUITMENT, OTHER
  description  String
  amount       Float
  month        Int      // 1-12
  isActual     Boolean  @default(true) // true = actual spend, false = forecast
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cycle      PlanningCycle @relation(fields: [cycleId], references: [id])
  costCenter CostCenter    @relation(fields: [costCenterId], references: [id])
}

// ============================================
// APPROVAL WORKFLOW
// ============================================

model Approval {
  id                   String   @id @default(cuid())
  approverId           String
  approverRole         String   // Role at time of approval
  status               String   @default("PENDING") // PENDING, APPROVED, REJECTED, REVISION_REQUESTED
  comments             String?
  step                 Int      @default(1) // 1=Dept, 2=BU, 3=Final

  // Polymorphic references - only one will be set
  budgetAllocationId   String?
  headcountPlanId      String?
  hiringProposalId     String?
  compensationActionId String?
  workforcePlanId      String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  approver           User                @relation(fields: [approverId], references: [id])
  budgetAllocation   BudgetAllocation?   @relation(fields: [budgetAllocationId], references: [id])
  headcountPlan      HeadcountPlan?      @relation(fields: [headcountPlanId], references: [id])
  hiringProposal     HiringProposal?     @relation(fields: [hiringProposalId], references: [id])
  compensationAction CompensationAction? @relation(fields: [compensationActionId], references: [id])
  workforcePlan      WorkforcePlan?      @relation(fields: [workforcePlanId], references: [id])
}

// ============================================
// APPROVAL CHAIN CONFIGURATION
// ============================================

// Approval Chain Level - defines each level in an approval chain for a planning cycle
model ApprovalChainLevel {
  id        String   @id @default(cuid())
  cycleId   String
  level     Int      // 1, 2, 3, etc.
  name      String?  // Optional name like "Department Review", "BU Approval"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cycle     PlanningCycle           @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  assignees ApprovalChainAssignee[]

  @@unique([cycleId, level])
  @@index([cycleId])
}

// Approval Chain Assignee - who can approve at each level
model ApprovalChainAssignee {
  id           String   @id @default(cuid())
  chainLevelId String

  // Assignment type - either a role or a specific user
  assigneeType String   // "ROLE" or "USER"

  // If assigneeType is "ROLE" - use this
  roleType     String?  // "REPORTING_MANAGER", "DEPARTMENT_HEAD", "BU_LEADER", "HR_ADMIN", "COMPENSATION_MANAGER"

  // If assigneeType is "USER" - use this
  userId       String?

  createdAt    DateTime @default(now())

  chainLevel   ApprovalChainLevel @relation(fields: [chainLevelId], references: [id], onDelete: Cascade)
  user         User?              @relation(fields: [userId], references: [id])

  @@index([chainLevelId])
}

// ============================================
// AUDIT LOGGING
// ============================================

model AuditLog {
  id           String   @id @default(cuid())
  entityType   String   // org_unit, budget_cycle, budget_allocation, headcount_plan, pay_grade, compensation_cycle, user, role
  entityId     String
  action       String   // create, update, delete, approve, reject, submit, override, status_change
  fieldChanged String?  // Specific field if update
  oldValue     Json?    // Previous value
  newValue     Json?    // New value
  userId       String
  userRole     String
  comment      String?
  ipAddress    String?
  sessionId    String?
  createdAt    DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// JOB ARCHITECTURE (Workforce Planning)
// ============================================

model JobFamily {
  id              String         @id @default(cuid())
  name            String
  code            String         @unique
  description     String?
  benchmarkSource String?        // e.g., "Radford", "Mercer"
  subFamilies     Json?          // JSONB for flexible sub-family metadata
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  jobSubFamilies JobSubFamily[]
  jobProfiles    JobProfile[]   // Direct link for simpler queries
}

model JobSubFamily {
  id          String    @id @default(cuid())
  jobFamilyId String
  name        String
  code        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  jobFamily   JobFamily    @relation(fields: [jobFamilyId], references: [id], onDelete: Cascade)
  jobProfiles JobProfile[]
  jobRoles    JobRole[]

  @@index([jobFamilyId])
}

// JobProfile replaces JobRole concept - represents a job template
model JobProfile {
  id            String    @id @default(cuid())
  title         String
  code          String    @unique
  familyId      String
  subFamilyId   String?
  level         Int?      // Seniority level (1-10)
  description   String?   // Job description
  kpis          Json?     // Key performance indicators as JSONB
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  jobFamily          JobFamily           @relation(fields: [familyId], references: [id])
  subFamily          JobSubFamily?       @relation(fields: [subFamilyId], references: [id])
  positions          Position[]
  compensationBands  CompensationBand[]

  @@unique([familyId, title])
  @@index([familyId])
  @@index([subFamilyId])
}

// CompensationBand - geo-based salary ranges with effective dates
model CompensationBand {
  id            String    @id @default(cuid())
  profileId     String
  geoCode       String    @default("IN-HYD") // Geographic code
  minSalary     Decimal   @db.Decimal(19, 4)
  midSalary     Decimal   @db.Decimal(19, 4)
  maxSalary     Decimal   @db.Decimal(19, 4)
  currency      String    @default("INR") @db.Char(3)
  effectiveFrom DateTime  @db.Date
  effectiveTo   DateTime? @db.Date
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile JobProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, geoCode, effectiveFrom])
  @@index([profileId])
}

// ============================================
// POSITION & ASSIGNMENT (The "Chair" Model)
// ============================================

// Position - The "Chair" - a funded slot that persists regardless of occupancy
model Position {
  id                   String    @id @default(cuid())
  titleOverride        String?   // Optional title override from profile
  profileId            String
  deptId               String
  isFrozen             Boolean   @default(false)
  targetHireDate       DateTime? @db.Date
  budgetAllocationId   String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  profile          JobProfile        @relation(fields: [profileId], references: [id])
  department       Department        @relation(fields: [deptId], references: [id])
  budgetAllocation PositionBudget?   @relation(fields: [budgetAllocationId], references: [id])
  assignments      Assignment[]

  @@index([profileId])
  @@index([deptId])
  @@index([budgetAllocationId])
}

// Assignment - Person in Chair - Temporal with matrix support
model Assignment {
  id             String    @id @default(cuid())
  empId          String
  positionId     String
  assignmentType String    @default("PRIMARY") // PRIMARY, SECONDARY, ACTING
  allocationPct  Decimal   @default(100.00) @db.Decimal(5, 2) // 0-100%
  validFrom      DateTime  @db.Date
  validTo        DateTime  @default("9999-12-31T00:00:00.000Z") @db.Date
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  employee              Employee              @relation(fields: [empId], references: [id])
  position              Position              @relation(fields: [positionId], references: [id])
  compensationSnapshots CompensationSnapshot[]

  @@unique([empId, positionId, validFrom])
  @@index([positionId])
  @@index([empId])
  @@index([validFrom, validTo])
}

// CompensationSnapshot - Temporal compensation data per assignment
model CompensationSnapshot {
  id            String    @id @default(cuid())
  assignmentId  String
  componentType String    // Base, Bonus, Equity, Allowance
  amountLocal   Decimal   @db.Decimal(19, 4)
  currencyLocal String    @default("INR") @db.Char(3)
  effectiveFrom DateTime  @db.Date
  effectiveTo   DateTime  @default("9999-12-31T00:00:00.000Z") @db.Date
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([effectiveFrom, effectiveTo])
}

// ============================================
// DEPARTMENT BUDGET & POSITION BUDGET
// ============================================

// DepartmentBudget - Per-cycle budget for a department
model DepartmentBudget {
  id          String   @id @default(cuid())
  cycleId     String
  deptId      String
  currency    String   @default("INR") @db.Char(3)
  totalBudget Decimal  @db.Decimal(19, 4)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cycle           PlanningCycle    @relation(fields: [cycleId], references: [id])
  department      Department       @relation(fields: [deptId], references: [id])
  positionBudgets PositionBudget[]

  @@unique([cycleId, deptId])
  @@index([cycleId])
  @@index([deptId])
}

// PositionBudget - Links budget to positions
model PositionBudget {
  id              String   @id @default(cuid())
  budgetId        String
  allocatedAmount Decimal  @db.Decimal(19, 4)
  consumedAmount  Decimal  @default(0) @db.Decimal(19, 4) // Technical debt - will be replaced by ledger
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  departmentBudget    DepartmentBudget     @relation(fields: [budgetId], references: [id])
  positions           Position[]
  budgetTransactions  BudgetTransaction[]

  @@index([budgetId])
}

// BudgetTransaction - Append-only ledger for budget tracking (v2 pattern)
model BudgetTransaction {
  id           String    @id @default(cuid())
  allocationId String
  amount       Decimal   @db.Decimal(19, 4) // Negative = encumbrance, positive = release
  txType       String    // ENCUMBER, RELEASE, ADJUST
  txDate       DateTime  @db.Date
  referenceId  String?   // e.g., assignment_id
  createdAt    DateTime  @default(now())

  positionBudget PositionBudget @relation(fields: [allocationId], references: [id])

  @@index([allocationId])
  @@index([txDate])
}

// ============================================
// LEGACY JOB ARCHITECTURE (Keep for backward compatibility)
// ============================================

model JobRole {
  id          String   @id @default(cuid())
  subFamilyId String
  name        String
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subFamily   JobSubFamily         @relation(fields: [subFamilyId], references: [id], onDelete: Cascade)
  levels      JobLevel[]
  planEntries WorkforcePlanEntry[]

  @@index([subFamilyId])
}

model JobLevel {
  id          String  @id @default(cuid())
  jobRoleId   String
  levelCode   String  // IC1, IC2, IC3, M1, M2
  levelName   String  // Junior, Mid, Senior, Manager, Senior Manager
  payGradeId  String?
  avgSalary   Float   @default(0)
  avgBenefits Float   @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jobRole     JobRole   @relation(fields: [jobRoleId], references: [id], onDelete: Cascade)
  payGrade    PayGrade? @relation(fields: [payGradeId], references: [id])
  planEntries WorkforcePlanEntry[]

  @@unique([jobRoleId, levelCode])
  @@index([jobRoleId])
  @@index([payGradeId])
}

// ============================================
// WORKFORCE PLANNING
// ============================================

model WorkforcePlan {
  id            String    @id @default(cuid())
  cycleId       String
  departmentId  String
  status        String    @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED, LOCKED
  submittedAt   DateTime?
  submittedById String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  cycle      PlanningCycle           @relation(fields: [cycleId], references: [id])
  department Department              @relation(fields: [departmentId], references: [id])
  scenarios  WorkforcePlanScenario[]
  approvals  Approval[]

  @@unique([cycleId, departmentId])
  @@index([cycleId])
  @@index([departmentId])
  @@index([status])
}

model WorkforcePlanScenario {
  id              String   @id @default(cuid())
  workforcePlanId String
  name            String   // "Baseline", "Growth", "Conservative"
  isBaseline      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workforcePlan WorkforcePlan        @relation(fields: [workforcePlanId], references: [id], onDelete: Cascade)
  entries       WorkforcePlanEntry[]
  exits         PlannedExit[]

  @@index([workforcePlanId])
}

model WorkforcePlanEntry {
  id               String  @id @default(cuid())
  scenarioId       String
  jobRoleId        String
  jobLevelId       String
  currentHeadcount Int     @default(0)
  q1Hires          Int     @default(0)
  q2Hires          Int     @default(0)
  q3Hires          Int     @default(0)
  q4Hires          Int     @default(0)
  plannedExits     Int     @default(0)
  avgCompensation  Float   @default(0)
  totalPayrollImpact Float @default(0)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  scenario WorkforcePlanScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  jobRole  JobRole               @relation(fields: [jobRoleId], references: [id])
  jobLevel JobLevel              @relation(fields: [jobLevelId], references: [id])

  @@unique([scenarioId, jobRoleId, jobLevelId])
  @@index([scenarioId])
  @@index([jobRoleId])
  @@index([jobLevelId])
}

model PlannedExit {
  id         String  @id @default(cuid())
  scenarioId String
  jobRoleId  String
  jobLevelId String
  exitMonth  Int     // 1-12
  exitCount  Int     @default(1)
  reason     String  // ATTRITION, RETIREMENT, RESTRUCTURING
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  scenario WorkforcePlanScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

model WorkforcePlanAssignment {
  id           String   @id @default(cuid())
  cycleId      String
  userId       String
  departmentId String?  // NULL = all departments
  accessLevel  String   // PLANNER, REVIEWER, ADMIN
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cycle      PlanningCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id])
  department Department?   @relation(fields: [departmentId], references: [id])

  @@unique([cycleId, userId, departmentId])
  @@index([cycleId])
  @@index([userId])
}
